variables:
  cloud_token: "{{env `VAGRANT_CLOUD_TOKEN`}}"
  headless: "false"

_DISTRIBUTIONS:
  # ================================================================================
  #
  # HERE THERE BE CENTOS
  #
  # ================================================================================
  centos6: &centos6
    iso_url: http://mirror.centos.org/centos/6/isos/x86_64/CentOS-6.10-x86_64-netinstall.iso
    iso_checksum: sha256:56f7b078a3b443095ba006cdc85319c691251cda98c5d73d12ef6db7aff6b4c1
    boot_command:
      - "<esc>"
      - "<wait>"
      - linux ks=http://{{.HTTPIP}}:{{.HTTPPort}}/centos-local/6/anaconda-ks.cfg
      - "<enter>"
    shutdown_command: sudo poweroff
  centos7: &centos7
    iso_url: http://mirror.centos.org/centos/7/isos/x86_64/CentOS-7-x86_64-NetInstall-2003.iso
    iso_checksum: sha256:101bc813d2af9ccf534d112cbe8670e6d900425b297d1a4d2529c5ad5f226372
    boot_command:
      - <esc>
      - <wait>
      - linux inst.ks=http://{{.HTTPIP}}:{{.HTTPPort}}/centos-local/7/anaconda-ks.cfg biosdevname=0 net.ifnames=0
      - <enter>
    shutdown_command: sudo systemctl poweroff
  centos8: &centos8
    <<: *centos7
    iso_url: http://mirror.centos.org/centos/8/isos/x86_64/CentOS-8.2.2004-x86_64-dvd1.iso
    iso_checksum: sha256:c87a2d81d67bbaeaf646aea5bedd70990078ec252fc52f5a7d65ff609871e255
    boot_command:
      - <esc>
      - <wait>
      - linux inst.ks=http://{{.HTTPIP}}:{{.HTTPPort}}/centos/CentOS-8-x86_64-Vagrant.ks biosdevname=0 net.ifnames=0
      - <enter>
  centos8_stream: &centos8_stream
    <<: *centos8
    iso_url: http://mirror.centos.org/centos/8-stream/isos/x86_64/CentOS-Stream-8-x86_64-20191219-boot.iso
    iso_checksum: sha256:3e80a092e15d7c96105aa995c4f92f1c08361cea4f75204bdbe51a1155359386
    boot_command:
      - <esc>
      - <wait>
      - linux inst.ks=http://{{.HTTPIP}}:{{.HTTPPort}}/centos/CentOS-8-Stream-x86_64-Vagrant.ks biosdevname=0 net.ifnames=0
      - <enter>
  # ================================================================================
  #
  # HERE THERE BE FEDORA
  #
  # ================================================================================
  rawhide: &rawhide
    iso_url: rawhide.iso
    iso_checksum: "{{user `rawhide_checksum`}}"
    boot_command:
      - "<tab> "
      - &fedora_boot >-
        inst.ks=http://{{.HTTPIP}}:{{.HTTPPort}}/fedora/{{split build_name "-" 1}}-{{split build_name "-" 2}}.ks
        biosdevname=0
        net.ifnames=0
      - <enter>
    shutdown_command: sudo systemctl poweroff
  fedora-33-x86_64: &fedora33
    <<: *rawhide
    iso_url: f33.iso
    iso_checksum: "{{user `f33_checksum`}}"
  fedora-32-x86_64: &fedora32
    <<: *rawhide
    iso_url: http://mirrors.kernel.org/fedora/releases/32/Server/x86_64/iso/Fedora-Server-netinst-x86_64-32-1.6.iso
    iso_checksum: sha256:7f4afd2a26c718f9f15e4bbfd9c2e8849f81036d2a82a4e81fa4a313a833da9c
  fedora-31-x86_64: &fedora31
    <<: *fedora32
    iso_url: http://mirrors.kernel.org/fedora/releases/31/Server/x86_64/iso/Fedora-Server-netinst-x86_64-31-1.9.iso
    iso_checksum: sha256:5be8debd3e8fb4e86b9fbf67c7eb66ea598d2b7ad0c7ba8d505ce88067b43444
  fedora-30-x86_64: &fedora30
    <<: *fedora31
    iso_url: http://mirrors.kernel.org/fedora/releases/30/Server/x86_64/iso/Fedora-Server-netinst-x86_64-30-1.2.iso
    iso_checksum: sha256:5e4eac4566d8c572bfb3bcf54b7d6c82006ec3c6c882a2c9235c6d3494d7b100

  # SILVERBLUE

  silverblue-32-x86_64: &silverblue32
    <<: *rawhide
    boot_command:
      - "<tab> "
      - &silverblue_boot >-
        inst.ks=http://{{.HTTPIP}}:{{.HTTPPort}}/silverblue/{{split build_name "-" 1}}.ks
        biosdevname=0
        net.ifnames=0
      - <enter>
    iso_url: https://mirrors.kernel.org/fedora/releases/32/Silverblue/x86_64/iso/Fedora-Silverblue-ostree-x86_64-32-1.6.iso
    iso_checksum: sha256:a241b624af5218cd8dc9b8459a34b6682d813fd6305ceab3d95e1f4da9803d7d

  # And Now Fedora ppc64le

  rawhide-ppc64le: &rawhide-ppc64le
    iso_url: rawhide_ppc.iso
    iso_checksum: "{{user `rawhide_ppc_checksum`}}"
    boot_command:
      - "e <down> <down> <end> "
      - *fedora_boot
      - <leftCtrlOn>x<leftCtrlOff>
  fedora-33-ppc64le: &fedora33ppc64le
    <<: *rawhide-ppc64le
    iso_url: f33-ppc64le.iso
    iso_checksum: "{{user `f33-ppc6le_checksum`}}"
  fedora-32-ppc64le: &fedora32ppc64le
    <<: *rawhide-ppc64le
    iso_url: http://mirrors.kernel.org/fedora-secondary/releases/32/Server/ppc64le/iso/Fedora-Server-netinst-ppc64le-32-1.6.iso
    iso_checksum: sha256:b5329424f0e1df7cd59c65e161d102d256a78201a0d78beb10854ca204711969
  fedora-31-ppc64le: &fedora31ppc64le
    <<: *rawhide-ppc64le
    iso_url: http://mirrors.kernel.org/fedora-secondary/releases/31/Server/ppc64le/iso/Fedora-Server-netinst-ppc64le-31-1.9.iso
    iso_checksum: sha256:af5c9338fc8f399b2c65f907cb906f9c4d1f9371782a4efaaee7a19321454810

_PROVIDERS:
  shared: &shared
    output_directory: output-{{build_name}}
    vm_name: packer-{{build_name}}
    disk_size: 20G
    headless: "{{user `headless`}}"
    http_directory: http
    boot_wait: 5s
    ssh_timeout: 358m
    ssh_username: vagrant
    ssh_password: vagrant
  qemu: &qemu
    <<: *shared
    type: qemu
    cpus: &cpus 2
    memory: &memory 2048
    qemuargs:
      - ["-serial", "stdio"]
  qemuppc64le: &qemuppc64le
    <<: *qemu
    qemu_binary: qemu-system-ppc64
    accelerator: none
    machine_type: pseries
    net_device: e1000e
    boot_wait: 55s
    qemuargs:
      - ["-cpu", power8]
      - ["-serial", "stdio"]
      - ["-vga", "virtio"]
        #- ["-nodefaults", ""]
  virtualbox: &virtualbox
    <<: *shared
    type: virtualbox-iso
    guest_os_type: other
    vboxmanage:
      -
        - modifyvm
        - "{{build_name}}"
        - "--memory"
        - *memory
      -
        - modifyvm
        - "{{build_name}}"
        - "--cpus"
        - *cpus
  vmware: &vmware
    <<: *shared
    type: vmware-iso
    guest_os_type: other
    vmx_data:
      memsize: *memory
      numvcpus: *cpus
    vmx_remove_ethernet_interfaces: true

provisioners:
  - type: ansible
    playbook_file: ansible/playbook.yml
  - type: shell
    script: scripts/minimize.sh
post-processors:
  -
    - type: vagrant
      compression_level: 9
      output: "{{build_name}}.box"
      vagrantfile_template: vagrantfile_templates/{{split build_name "-" 2}}.rb
      keep_input_artifact: true
    - type: vagrant-cloud
      box_tag: greg-hellings/{{split build_name "-" 0}}-{{split build_name "-" 1}}-{{split build_name "-" 2}}
      access_token: "{{user `cloud_token`}}"
      version: "{{isotime \"2006010203\"}}"

builders:
  - <<: [ *qemu, *centos6 ]
    name: centos-6-x86_64-qemu
  - <<: [ *qemu, *centos7 ]
    name: centos-7-x86_64-qemu
  - <<: [ *qemu, *centos8 ]
    name: centos-8-x86_64-qemu
  - <<: [ *qemu, *centos8_stream ]
    name: centos-8_stream-x86_64-qemu

  - <<: [ *qemu, *fedora30 ]
    name: fedora-30-x86_64-qemu
  - <<: [ *qemu, *fedora31 ]
    name: fedora-31-x86_64-qemu
  - <<: [ *qemu, *fedora32 ]
    name: fedora-32-x86_64-qemu
  - <<: [ *qemu, *fedora33 ]
    name: fedora-33-x86_64-qemu
  - <<: [ *qemu, *rawhide ]
    name: fedora-rawhide-x86_64-qemu

  - <<: [ *qemu, *silverblue32 ]
    name: fedora-32-silverblue-qemu

  - <<: [ *qemuppc64le, *fedora31ppc64le ]
    name: fedora-31-ppc64le-qemu
  - <<: [ *qemuppc64le, *fedora32ppc64le ]
    name: fedora-32-ppc64le-qemu
  - <<: [ *qemuppc64le, *fedora33ppc64le ]
    name: fedora-33-ppc64le-qemu
  - <<: [ *qemuppc64le, *rawhide-ppc64le ]
    name: fedora-rawhide-ppc64le-qemu
