variables:
  rawhide_url: ''
  rawhide_checksum: ''
  cloud_token: "{{env `VAGRANT_CLOUD_TOKEN`}}"
  headless: "false"

_DISTRIBUTIONS:
  rawhide: &rawhide
    iso_url: "{{user `rawhide_url`}}"
    iso_checksum: "{{user `rawhide_checksum`}}"
    disk_image: true
    boot_command:
    #  - "<tab> "
    #  - "inst.ks=http://{{.HTTPIP}}:{{.HTTPPort}}/fedora/{{split build_name \"-\" 1}}.ks "
    #  - "biosdevname=0 "
    #  - "net.ifnames=0 "
      - <enter>
    shutdown_command: sudo systemctl poweroff
  fedora32ppc64le: &fedora32ppc64le
    <<: *rawhide
    iso_url: http://mirror.math.princeton.edu/pub/fedora-secondary/releases/32/Cloud/ppc64le/images/Fedora-Cloud-Base-32-1.6.ppc64le.qcow2
    iso_checksum: dd989a078d641713c55720ba3e4320b204ade6954e2bfe4570c8058dc36e2e5d
  fedora32: &fedora32
    <<: *rawhide
    iso_url: http://mirror.math.princeton.edu/pub/fedora/linux/releases/32/Cloud/x86_64/images/Fedora-Cloud-Base-32-1.6.x86_64.qcow2
    iso_checksum: 423a4ce32fa32c50c11e3d3ff392db97a762533b81bef9d00599de518a7469c8
  fedora31ppc64le: &fedora31ppc64le
    <<: *fedora32ppc64le
    iso_url: https://mirror.chpc.utah.edu/pub/fedora-secondary/releases/31/Cloud/ppc64le/images/Fedora-Cloud-Base-31-1.9.ppc64le.qcow2
    iso_checksum: 7c3528b85a3df4b2306e892199a9e1e43f991c506f2cc390dc4efa2026ad2f58
  fedora31: &fedora31
    <<: *fedora32
    iso_url: http://mirror.math.princeton.edu/pub/fedora/linux/releases/31/Cloud/x86_64/images/Fedora-Cloud-Base-31-1.9.x86_64.qcow2
    iso_checksum: e3c1b309d9203604922d6e255c2c5d098a309c2d46215d8fc026954f3c5c27a0
  fedora30: &fedora30
    <<: *fedora31
    iso_url: http://mirror.math.princeton.edu/pub/fedora/linux/releases/30/Cloud/x86_64/images/Fedora-Cloud-Base-30-1.2.x86_64.qcow2
    iso_checksum: 72b6ae7b4ed09a4dccd6e966e1b3ac69bd97da419de9760b410e837ba00b4e26

provisioners:
  - type: ansible
    playbook_file: ansible/playbook.yml
  - type: shell
    script: scripts/minimize.sh
post-processors:
  -
    - type: vagrant
      compression_level: 6
      output: "{{build_name}}.box"
      vagrantfile_template: vagrantfile_templates/{{split build_name "-" 2}}.rb
      keep_input_artifact: true
    - type: vagrant-cloud
      box_tag: greg-hellings/{{split build_name "-" 0}}-{{split build_name "-" 1}}-{{split build_name "-" 2}}
      access_token: "{{user `cloud_token`}}"
      version: "{{isotime \"2006010203\"}}"

_PROVIDERS:
  shared: &shared
    iso_checksum_type: sha256
    output_directory: output-{{build_name}}
    vm_name: packer-{{build_name}}
    disk_size: 40G
    headless: "{{user `headless`}}"
    http_directory: http
    boot_wait: 5s
    ssh_timeout: 358m
    ssh_username: vagrant
    ssh_password: vagrant
  qemu: &qemu
    <<: *shared
    type: qemu
    cpus: &cpus 2
    memory: &memory 2048
    qemuargs:
      - ["-cdrom", "http/cloud-init/config.iso"]
  qemuppc64le: &qemuppc64le
    <<: *qemu
    qemu_binary: qemu-system-ppc64
    accelerator: none
    machine_type: pseries
    cpus: 2
    memory: 2048
    net_device: virtio-net-pci
    iso_target_extension: qcow2
    qemuargs:
      - ["-cpu", power8]
      - ["-cdrom", "http/cloud-init/config.iso"]
      - ["-nodefaults", ""]
  virtualbox: &virtualbox
    <<: *shared
    type: virtualbox-iso
    guest_os_type: other
    vboxmanage:
      -
        - modifyvm
        - "{{build_name}}"
        - "--memory"
        - *memory
      -
        - modifyvm
        - "{{build_name}}"
        - "--cpus"
        - *cpus
  vmware: &vmware
    <<: *shared
    type: vmware-iso
    guest_os_type: other
    vmx_data:
      memsize: *memory
      numvcpus: *cpus
    vmx_remove_ethernet_interfaces: true

builders:
  - <<: [ *qemu, *fedora30 ]
    name: fedora-30-x86_64-qemu
  - <<: [ *qemu, *fedora31 ]
    name: fedora-31-x86_64-qemu
  - <<: [ *qemuppc64le, *fedora31ppc64le ]
    name: fedora-31-ppc64le-qemu
  - <<: [ *qemu, *fedora32 ]
    name: fedora-32-x86_64-qemu
  - <<: [ *qemuppc64le, *fedora32ppc64le ]
    name: fedora-32-ppc64le-qemu
  - <<: [ *qemu, *rawhide ]
    name: fedora-rawhide-x86_64-qemu
